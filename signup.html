<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UniX - Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Auth CSS -->
  <link rel="stylesheet" href="style.css">
</head>

<body class="auth-page">

  <div class="auth-container">

    <div class="auth-logo"></div>

    <h2>Join UniX</h2>
    <p class="auth-subtext">Create your campus account</p>

    <form class="auth-card" id="registerForm">

      <label>Full Name</label>
      <input
        type="text"
        id="name"
        placeholder="John Doe"
        required
      >

      <label>Password</label>
      <input
        type="password"
        id="password"
        placeholder="Create a strong password"
        required
      >

      <label>Email</label>
      <input 
        type="email" 
        id="email"
        name="email"
        placeholder="Enter your email"
        required
      >

      <label>Role</label>
      <select id="role">
        <option>Student</option>
        <option>Faculty</option>
      </select>

      <!-- Dynamic Fields Container -->
      <div id="dynamicField"></div>

      <button class="primary-btn" type="submit">
        Create Account
      </button>

      <p class="auth-footer">
        Already have an account?
        <a href="login.html">Sign in</a>
      </p>

    </form>
  </div>


  <script type="module">
  import { auth } from "./firebase.js";

  import { 
    createUserWithEmailAndPassword,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

  import { 
    getFirestore,
    doc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const db = getFirestore();

  const form = document.getElementById("registerForm");
  const roleSelect = document.getElementById("role");
  const dynamicField = document.getElementById("dynamicField");

  function renderField() {
    if (roleSelect.value === "Student") {
      dynamicField.innerHTML = `
        <label>Register Number</label>
        <input type="text" id="regNo" placeholder="eg:- CEC23CS078" required>
      `;
    } else {
      dynamicField.innerHTML = "";
    }
  }

  renderField();
  roleSelect.addEventListener("change", renderField);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const role = roleSelect.value;

    // Email validation (for both roles)
   // Basic email format check (for everyone)
const generalEmailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

if (!generalEmailPattern.test(email)) {
  alert("Enter a valid email address");
  return;
}

// Additional restriction only for Faculty
if (role === "Faculty") {
  const facultyPattern = /^[a-zA-Z0-9._%+-]+@cec\.clg$/i;

  if (!facultyPattern.test(email)) {
    alert("Faculty must use a valid @cec.clg email address");
    return;
  }
}

    // Student register number validation
    let regNo = null;
    if (role === "Student") {
      regNo = document.getElementById("regNo").value.toUpperCase();
      const regPattern = /^CEC[0-9]{2}(CS|EC|AD|EE)[0-9]{3}$/;

      if (!regPattern.test(regNo)) {
        alert("Invalid Register Number (Example: CEC23CS078)");
        return;
      }
    }

    // Password validation
    const passwordValid =
      password.length >= 6 &&
      /[0-9]/.test(password) &&
      /[a-zA-Z]/.test(password) &&
      /[!@#$%^&*]/.test(password);

    if (!passwordValid) {
      alert("Password must contain letters, numbers & special characters");
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Save name in Firebase Auth
      await updateProfile(user, {
        displayName: name
      });

      // Save user in Firestore
      await setDoc(doc(db, "users", user.uid), {
  name,
  email,
  role,
  regNo: regNo || null,
  points: 1000,
  createdAt: new Date()
});

// Create welcome notification
await setDoc(doc(db, "users", user.uid, "notifications", "welcome"), {
  message: "ðŸŽ‰ Welcome to UniX! You earned 1000 points.",
  createdAt: new Date(),
  read: false
});

      window.location.href = "dashboard.html";

    } catch (error) {
      console.log(error.code);
      alert("Registration failed. Try another email.");
    }
  });
</script>

</body>
</html>