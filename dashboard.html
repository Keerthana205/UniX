<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UniX - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Combined Styles -->
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="layout">
    <div id="navbar-container"></div>

    <div class="page-content">
      <div class="dashboard">

        <h1 id="welcomeText">Welcome back!</h1>

        <p class="subtitle">
          Here's what's happening in your campus community
        </p>

        <!-- Notification Box -->
        <div id="notificationBox" class="notification-box" style="display:none;"></div>

        <!-- Points Card -->
        <div class="points-card">
          <div>
            <p>Your Points</p>
            <h2>
              <i class="fa-solid fa-coins"></i>
              <span id="dashboardPointsValue">0</span>
            </h2>
            <small>Earn more by helping your peers</small>
          </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">

  <!-- Open Requests -->
  <div class="stat-card">
    <div class="stat-left">
      <div class="stat-icon purple">
        <i class="fa-solid fa-user-group"></i>
      </div>
      <div class="stat-text">
        <h4>Open Requests</h4>
        <p>Help requests waiting for you</p>
      </div>
    </div>
    <div class="stat-value">
      <h2 id="openRequestsCount">0</h2>
    </div>
  </div>

  <!-- Active Listings -->
  <div class="stat-card">
    <div class="stat-left">
      <div class="stat-icon green">
        <i class="fa-solid fa-shop"></i>
      </div>
      <div class="stat-text">
        <h4>Active Listings</h4>
        <p>Items available for trade</p>
      </div>
    </div>
    <div class="stat-value">
      <h2 id="activeListingsCount">0</h2>
    </div>
  </div>

  <!-- Lost Items -->
  <div class="stat-card">
    <div class="stat-left">
      <div class="stat-icon yellow">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <div class="stat-text">
        <h4>Lost Items</h4>
        <p>Waiting to be found</p>
      </div>
    </div>
    <div class="stat-value">
      <h2 id="lostItemsCount">0</h2>
    </div>
  </div>

</div>
        <!-- Recent Section -->
        <div class="recent-section">
          <h2>Recent Transactions</h2>
          <div class="recent-box" id="recentTransactionsBox">
            No transactions yet.
          </div>
        </div>

      </div>
    </div>
  </div>

 <script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } 
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { 
  doc, getDoc, collection, getDocs, updateDoc,
  query, where, orderBy, limit 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// Load navbar first
fetch("navbar.html")
  .then(res => res.text())
  .then(async (data) => {

    document.getElementById("navbar-container").innerHTML = data;
    setActiveLink();

    const logoutBtn = document.getElementById("logoutBtn");
    const usernameValue = document.getElementById("usernameValue");
    const navPointsValue = document.getElementById("navPointsValue");
    const dashboardPointsValue = document.getElementById("dashboardPointsValue");
    const welcomeText = document.getElementById("welcomeText");
    const notificationBox = document.getElementById("notificationBox");

    const openRequestsCount = document.getElementById("openRequestsCount");
    const activeListingsCount = document.getElementById("activeListingsCount");
    const lostItemsCount = document.getElementById("lostItemsCount");
    const recentTransactionsBox = document.getElementById("recentTransactionsBox");

    onAuthStateChanged(auth, async (user) => {

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        // ðŸ”¹ Fetch User Info
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const data = userSnap.data();
          const points = data.points ?? 0;

          if (usernameValue) usernameValue.innerText = data.name || "User";
          if (welcomeText) welcomeText.innerText = `Welcome back, ${data.name || "User"}!`;
          if (navPointsValue) navPointsValue.innerText = points;
          if (dashboardPointsValue) dashboardPointsValue.innerText = points;
        }

        // ðŸ”¹ Open Requests Count
        const openReqQuery = query(
          collection(db, "requests"),
          where("createdBy", "==", user.uid),
          where("status", "==", "open")
        );
        const openReqSnap = await getDocs(openReqQuery);
        if (openRequestsCount) openRequestsCount.innerText = openReqSnap.size;

        // ðŸ”¹ Active Listings Count
        const activeListQuery = query(
          collection(db, "listings"),
          where("createdBy", "==", user.uid),
          where("status", "==", "active")
        );
        const activeListSnap = await getDocs(activeListQuery);
        if (activeListingsCount) activeListingsCount.innerText = activeListSnap.size;

        // ðŸ”¹ Lost Items Count
        const lostItemsQuery = query(
          collection(db, "lostItems"),
          where("createdBy", "==", user.uid),
          where("status", "==", "lost")
        );
        const lostItemsSnap = await getDocs(lostItemsQuery);
        if (lostItemsCount) lostItemsCount.innerText = lostItemsSnap.size;

        // ðŸ”¹ Recent Transactions (Categorized)
const recentQuery = query(
  collection(db, "transactions"),
  where("userId", "==", user.uid),
  orderBy("createdAt", "desc"),
  limit(5)
);

const recentSnap = await getDocs(recentQuery);

if (recentTransactionsBox) {

  if (recentSnap.empty) {
    recentTransactionsBox.innerHTML = `
      <div class="txn-item empty">
        No transactions yet.
      </div>
    `;
  } else {

    recentTransactionsBox.innerHTML = "";

    recentSnap.forEach(docSnap => {
      const data = docSnap.data();

      let icon = "";
      let extraInfo = "";

      // ðŸŽ¯ Category Based Rendering
      if (data.category === "skill") {
        icon = `<i class="fa-solid fa-user-group txn-icon purple"></i>`;
        extraInfo = data.pointsChange 
          ? `<span class="txn-points positive">+${data.pointsChange} pts</span>`
          : "";
      }

      else if (data.category === "marketplace") {
        icon = `<i class="fa-solid fa-shop txn-icon green"></i>`;
        extraInfo = data.amount 
          ? `<span class="txn-amount">â‚¹${data.amount}</span>`
          : "";
      }

      else if (data.category === "lostfound") {
        icon = `<i class="fa-solid fa-magnifying-glass txn-icon yellow"></i>`;
      }

      const transactionHTML = `
        <div class="txn-item">
          <div class="txn-left">
            ${icon}
            <span class="txn-title">${data.title}</span>
          </div>
          ${extraInfo}
        </div>
      `;

      recentTransactionsBox.innerHTML += transactionHTML;
    });
  }
}

        // ðŸ”¹ Notifications
        const notifRef = collection(db, "users", user.uid, "notifications");
        const notifSnap = await getDocs(notifRef);

        notifSnap.forEach(async (docSnap) => {
          const notif = docSnap.data();
          if (!notif.read && notificationBox) {
            notificationBox.innerText = notif.message;
            notificationBox.style.display = "block";
            await updateDoc(docSnap.ref, { read: true });

            setTimeout(() => {
              notificationBox.style.display = "none";
            }, 5000);
          }
        });

      } catch (error) {
        console.error("Dashboard error:", error);
      }
    });

    // ðŸ”¹ Logout
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        await signOut(auth);
        window.location.href = "home.html";
      });
    }
  });

function setActiveLink() {
  const currentPage = window.location.pathname
    .split("/")
    .pop()
    .replace(".html", "");

  document.querySelectorAll(".nav-links a").forEach(link => {
    if (link.dataset.link === currentPage) {
      link.classList.add("active");
    }
  });
}
</script>
</body>
</html>